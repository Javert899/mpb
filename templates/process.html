<html>
    <head>
        <script type="text/javascript" src="static/humanize-duration.js"></script>
        <script type="text/javascript" src="static/hostname.js"></script>
        <script type="text/javascript" src="static/viz.js"></script>
        <script type="text/javascript" src="static/jquery.min.js"></script>
        <script type="text/javascript" src="static/process_repr.js"></script>
        <title>PADS IoP app - Process View</title>
    </head>
    <body>
        <div style="height: 12%; background-color: white">
            <table style="border: 0">
                <tr>
                    <td style="width: 20%">
                        <a href="upload.html"><img src="static/pads_rwth.png" style="width: 100%" /></a>
                    </td>
                    <td style="width: 80%">
                        <button id="conformance_view_button" style="display: " onclick="javascript:switchToConformanceView()">Swith to Conformance View</button>
                        <button id="process_view_button" style="display: none" onclick="javascript:switchToProcessView()">Switch to Process View</button>
                        <button id="apply_changes" style="display: " onclick="javascript:applyChanges()">Apply Changes</button><br />
                        % act.: <input id="af_slider" type="range" min="0" max="100" value="20" class="slider">
                        % paths: <input id="pf_slider" type="range" min="0" max="100" value="20" class="slider"><br />
                        Zeta (TempCC): <input id="zeta_slider" type="range" min="1" max="10" value="2" class="slider">
                        Noise (Lsk CFCC): <input id="lsk_slider" type="range" min="0" max="30" value="2" class="slider">
                        BH: <input type="checkbox" id="bh_enabled" />
                    </td>
                </tr>
            </table>
        </div>
        <div style="height: 88%; background-color: white">
            <div id="process_view" style="display: ">
                <div id="svg_view">

                </div>
            </div>
            <div id="conformance_view" style="display: none">
                <button id="view_lsk_activities" onclick="javascript:viewLskActivities()">Activities LSK</button>
                <button id="view_lsk_cases" onclick="javascript:viewLskCases()">Cases LSK</button>
                <button id="view_tp_activities" onclick="javascript:viewTpActivities()">Activities TP</button>
                <button id="view_tp_cases" onclick="javascript:viewTpCases()">Cases TP</button>
                <button id="view_tp_activities" onclick="javascript:viewUrResources()">UR resources</button>
                <button id="view_tp_cases" onclick="javascript:viewUrCases()">UR cases</button>
                <button id="view_decision_tree" onclick="javascript:viewDecisionTree()">Decision Tree</button>
                <div id="lsk_activities0" style="display: ">
                    <h2>Activities violating the Control Flow</h2>
                    <h5>(detail based on the Log Skeleton)</h5>
                    <div id="lsk_activities"></div>
                </div>
                <div id="lsk_cases0" style="display: none">
                    <h2>Cases violating the Control Flow</h2>
                    <h5>(detail based on the Log Skeleton)</h5>
					<span style="display: none" id="lsk_cases_list"></span>
					<button onclick="javascript:showDifferenceDeviations('lsk_cases_list')">Analyze Deviations with Decision Tree</button>
                    <div id="lsk_cases"></div>
                </div>
                <div id="tp_activities0" style="display: none">
                    <h2>Activities violating the Time Perspective</h2>
                    <h5>(detail based on the Temporal Profile)</h5>
                    <div id="tp_activities"></div>
                </div>
                <div id="tp_cases0" style="display: none">
                    <h2>Cases violating the Time Perspective</h2>
                    <h5>(detail based on the Temporal Profile)</h5>
					<span style="display: none" id="tp_cases_list"></span>
					<button onclick="javascript:showDifferenceDeviations('tp_cases_list')">Analyze Deviations with Decision Tree</button>
                    <div id="tp_cases"></div>
                </div>
                <div id="ur_resources0" style="display: none">
                    <h2>Underperforming resources (resources with count)</h2>
                    <div id="ur_resources"></div>
                </div>
                <div id="ur_cases0" style="display: none">
                    <h2>Underperforming resources (cases)</h2>
					<span style="display: none" id="ur_cases_list"></span>
					<button onclick="javascript:showDifferenceDeviations('ur_cases_list')">Analyze Deviations with Decision Tree</button>
                    <div id="ur_cases"></div>
                </div>
                <div id="decisiontree0" style="display: none">
				    <h2>Decision Tree</h2>
                    <h5>(conditions leading to higher duration)</h5>
					<div id="decisiontree"></div>
				</div>
            </div>
        </div>
        <script type="text/javascript">
        var parseQueryString = function() {

            var str = window.location.search;
            var objURL = {};

            str.replace(
                new RegExp( "([^?=&]+)(=([^&]*))?", "g" ),
                function( $0, $1, $2, $3 ){
                    objURL[ $1 ] = $3;
                }
            );
            return objURL;
        };

            const urlParams = parseQueryString();
            var uuid = urlParams['uuid'];
            var encodedParameters = urlParams['parameters'];
            let decodedParameters = null;
            if (encodedParameters != null && typeof(encodedParameters) != "undefined") {
                decodedParameters = JSON.parse(atob(encodedParameters));
                setDecodedParameters();
            }
            var returnedData = null;

            function switchToConformanceView() {
                document.getElementById("process_view").style.display = "none";
                document.getElementById("conformance_view").style.display = "";
                document.getElementById("conformance_view_button").style.display = "none";
                document.getElementById("process_view_button").style.display = "";
            }

            function switchToProcessView() {
                document.getElementById("process_view").style.display = "";
                document.getElementById("conformance_view").style.display = "none";
                document.getElementById("conformance_view_button").style.display = "";
                document.getElementById("process_view_button").style.display = "none";
            }

            function getProcess() {
                let hostnamePort = getHostname();
                let hostname = hostnamePort["hostname"];
                let port = hostnamePort["port"];
                let url = "http://"+hostname+":"+port+"/processService";
                url += "?uuid="+uuid;
                if (encodedParameters != null && typeof(encodedParameters) != "undefined") {
                    url += "&parameters="+encodedParameters;
                }
                $.get(url, function(data) {
                    returnedData = data;
                    fillDeviations();
                    representProcessModel();
                });
            }
			
			function showDifferenceDeviations(cases_container) {
				let cases = document.getElementById(cases_container).innerHTML.split(",");
				let i = 0;
				while (i < cases.length) {
					cases[i] = parseInt(cases[i]);
					i++;
				}
				let hostnamePort = getHostname();
                let hostname = hostnamePort["hostname"];
                let port = hostnamePort["port"];
                let url = "http://"+hostname+":"+port+"/decisionTreeService";
				let decodedParameters2 = {};
				if (decodedParameters != null) {
					Object.assign(decodedParameters2, decodedParameters);
				}
				decodedParameters2["deviating_cases"] = cases;
				let encodedParameters2 = JSON.stringify(decodedParameters2);
				let encodedParameters3 = btoa(encodedParameters2);
                url += "?uuid="+uuid;
                if (encodedParameters2 != null && typeof(encodedParameters2) != "undefined") {
                    url += "&parameters="+encodedParameters3;
                }
				console.log(url);
				window.open(url);
			}

            function representProcessModel() {
                let svgXml = Viz(reprModel(returnedData["model"]), { format: "svg"});
                document.getElementById("svg_view").innerHTML = svgXml;
            }

            function applyChanges() {
                let af = document.getElementById("af_slider").value / 100.0;
                let pf = document.getElementById("pf_slider").value / 100.0;
                let zeta = document.getElementById("zeta_slider").value * 1.0;
                let noise_threshold = document.getElementById("lsk_slider").value / 100.0;
                let business_hours = document.getElementById("bh_enabled").checked;
                let dictio = {};
                dictio["activity_percentage"] = af;
                dictio["paths_percentage"] = pf;
                dictio["zeta"] = zeta;
                dictio["noise_threshold"] = noise_threshold;
                dictio["business_hours"] = business_hours;
                dictio = JSON.stringify(dictio);
                encodedParameters = btoa(dictio);
                loadPage();
            }

            function setDecodedParameters() {
                document.getElementById("af_slider").value = 100.0 * decodedParameters["activity_percentage"];
                document.getElementById("pf_slider").value = 100.0 * decodedParameters["paths_percentage"];
                document.getElementById("zeta_slider").value = decodedParameters["zeta"];
                document.getElementById("lsk_slider").value = 100.0 * decodedParameters["noise_threshold"];
                document.getElementById("bh_enabled").checked = decodedParameters["business_hours"];
            }

            function loadPage() {
                window.location.href = "process.html?uuid="+this.uuid+"&parameters="+this.encodedParameters;
            }

            function hideEverything() {
                document.getElementById("lsk_activities0").style.display = "none";
                document.getElementById("lsk_cases0").style.display = "none";
                document.getElementById("tp_activities0").style.display = "none";
                document.getElementById("tp_cases0").style.display = "none";
                document.getElementById("ur_resources0").style.display = "none";
                document.getElementById("ur_cases0").style.display = "none";
                document.getElementById("decisiontree0").style.display = "none";
            }

            function viewLskActivities() {
                hideEverything();
                document.getElementById("lsk_activities0").style.display = "";
            }

            function viewLskCases() {
                hideEverything();
                document.getElementById("lsk_cases0").style.display = "";
            }

            function viewTpActivities() {
                hideEverything();
                document.getElementById("tp_activities0").style.display = "";
            }

            function viewTpCases() {
                hideEverything();
                document.getElementById("tp_cases0").style.display = "";
            }
			
			function viewUrResources() {
				hideEverything();
                document.getElementById("ur_resources0").style.display = "";
			}
			
			function viewUrCases() {
				hideEverything();
				document.getElementById("ur_cases0").style.display = "";
			}
			
			function viewDecisionTree() {
				hideEverything();
				document.getElementById("decisiontree0").style.display = "";
			}

            function fillDeviations() {
                fillDivWithDeviations(returnedData["activity_lsk_conf"], "lsk_activities", returnedData["case_ids"]);
                fillDivWithDeviations(returnedData["lsk_conf_cases"], "lsk_cases", returnedData["case_ids"]);
                fillDivWithDeviations(returnedData["activity_ts_conf"], "tp_activities", returnedData["case_ids"]);
                fillDivWithDeviations(returnedData["ts_conf_cases"], "tp_cases", returnedData["case_ids"]);
                fillDivWithDeviations(returnedData["resource_ur"], "ur_resources", returnedData["case_ids"]);
                fillDivWithDeviations(returnedData["cases_ur"], "ur_cases", returnedData["case_ids"]);
				
				let lsk_cases_list = [];
				let tp_cases_list = [];
				let ur_cases_list = [];
				
				let lsk_conf_keys = Object.keys(returnedData["lsk_conf_cases"]);
				let tp_conf_keys = Object.keys(returnedData["ts_conf_cases"]);
				let cases_ur_keys = Object.keys(returnedData["cases_ur"]);
				
				let i = 0;
				while (i < lsk_conf_keys.length) {
					if (returnedData["lsk_conf_cases"][lsk_conf_keys[i]].length > 0) {
						lsk_cases_list.push(lsk_conf_keys[i]);
					}
					i++;
				}
				i = 0;
				while (i < tp_conf_keys.length) {
					if (returnedData["ts_conf_cases"][tp_conf_keys[i]].length > 0) {
						tp_cases_list.push(tp_conf_keys[i]);
					}
					i++;
				}
				i = 0;
				while (i < cases_ur_keys.length) {
					if (returnedData["cases_ur"][cases_ur_keys[i]].length > 0) {
						ur_cases_list.push(cases_ur_keys[i]);
					}
					i++;
				}
				
				document.getElementById("lsk_cases_list").innerHTML = lsk_cases_list;
				document.getElementById("tp_cases_list").innerHTML = tp_cases_list;
				document.getElementById("ur_cases_list").innerHTML = ur_cases_list;
				
				document.getElementById("decisiontree").innerHTML = returnedData["decision_tree"];
            }

            function fillDivWithDeviations(deviations, target_div, case_ids) {
                let count = 0;
				let situation = 2;
				try {
					for (let dev of deviations) {
						situation = 1;
						break;
					}
				}
				catch (err) {
					
				}
                for (let dev in deviations) {
                    let key = null;
                    let value = null;
                    if (situation == 1) {
                        key = case_ids[count];
                        value = deviations[dev];
                    }
                    else {
                        key = dev;
                        value = deviations[dev];
                    }
                    if (value.length > 0) {
                        let span1 = document.createElement("div");
                        let span2 = document.createElement("ul");
                        span1.setAttribute("id", target_div+"_S1_"+count);
                        span2.setAttribute("id", target_div+"_S2_"+count);
                        span2.style.display = "none";
                        document.getElementById(target_div).appendChild(span1);
                        document.getElementById(target_div).appendChild(span2);
                        span1.innerHTML = "<a href=\"javascript:changeVisibility('"+target_div+"_S2_"+count+"')\">"+key+" (n.dev: "+value.length+")</a>";
                        for (let subdev_idx in value) {
                            let subdev = value[subdev_idx];
                            let list_item = document.createElement("li");
                            list_item.innerHTML = subdev;
                            span2.appendChild(list_item);
                        }
                    }
                    count++;
                }
            }

            function changeVisibility(element_id) {
                if (document.getElementById(element_id).style.display == "none") {
                    document.getElementById(element_id).style.display = "";
                }
                else {
                    document.getElementById(element_id).style.display = "none";
                }
            }

            getProcess();
        </script>
    </body>
</html>
