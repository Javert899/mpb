<html>
    <head>
        <script type="text/javascript" src="humanize-duration.js"></script>
        <script type="text/javascript" src="hostname.js"></script>
        <script type="text/javascript" src="viz.js"></script>
        <script type="text/javascript" src="jquery.min.js"></script>
        <script type="text/javascript" src="process_repr.js"></script>
    </head>
    <body>
        <div style="height: 12%; background-color: white">
            <table style="border: 0">
                <tr>
                    <td style="width: 20%">
                        <img src="pads_rwth.png" style="width: 100%" />
                    </td>
                    <td style="width: 80%">
                        <button id="conformance_view_button" style="display: " onclick="javascript:switchToConformanceView()">Swith to Conformance View</button>
                        <button id="process_view_button" style="display: none" onclick="javascript:switchToProcessView()">Switch to Process View</button>
                        <button id="apply_changes" style="display: " onclick="javascript:applyChanges()">Apply Changes</button><br />
                        % act.: <input id="af_slider" type="range" min="0" max="100" value="20" class="slider">
                        % paths: <input id="pf_slider" type="range" min="0" max="100" value="20" class="slider"><br />
                        Zeta (TempCC): <input id="zeta_slider" type="range" min="0" max="10" value="2" class="slider">
                        Noise (Lsk CFCC): <input id="lsk_slider" type="range" min="0" max="30" value="2" class="slider">
                        BH: <input type="checkbox" id="bh_enabled" />
                    </td>
                </tr>
            </table>
        </div>
        <div style="height: 88%; background-color: white">
            <div id="process_view" style="display: ">
                <div id="svg_view">

                </div>
            </div>
            <div id="conformance_view" style="display: none">
                <button id="view_lsk_activities" onclick="javascript:viewLskActivities()">Activities LSK</button>
                <button id="view_lsk_cases" onclick="javascript:viewLskCases()">Cases LSK</button>
                <button id="view_tp_activities" onclick="javascript:viewTpActivities()">Activities TP</button>
                <button id="view_tp_cases" onclick="javascript:viewTpCases()">Cases TP</button>
                <div id="lsk_activities0" style="display: ">
                    <h2>Activities violating the Control Flow</h2>
                    <h5>(detail based on the Log Skeleton)</h5>
                    <div id="lsk_activities"></div>
                </div>
                <div id="lsk_cases0" style="display: none">
                    <h2>Cases violating the Control Flow</h2>
                    <h5>(detail based on the Log Skeleton)</h5>
                    <div id="lsk_cases"></div>
                </div>
                <div id="tp_activities0" style="display: none">
                    <h2>Activities violating the Time Perspective</h2>
                    <h5>(detail based on the Temporal Profile)</h5>
                    <div id="tp_activities"></div>
                </div>
                <div id="tp_cases0" style="display: none">
                    <h2>Cases violating the Time Perspective</h2>
                    <h5>(detail based on the Temporal Profile)</h5>
                    <div id="tp_cases"></div>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            var uuid = urlParams.get('uuid');
            var returnedData = null;

            function switchToConformanceView() {
                document.getElementById("process_view").style.display = "none";
                document.getElementById("conformance_view").style.display = "";
                document.getElementById("conformance_view_button").style.display = "none";
                document.getElementById("process_view_button").style.display = "";
            }

            function switchToProcessView() {
                document.getElementById("process_view").style.display = "";
                document.getElementById("conformance_view").style.display = "none";
                document.getElementById("conformance_view_button").style.display = "";
                document.getElementById("process_view_button").style.display = "none";
            }

            function getProcess() {
                let hostnamePort = getHostname();
                let hostname = hostnamePort["hostname"];
                let port = hostnamePort["port"];
                let url = "http://"+hostname+":"+port+"/processService";
                $.get(url, function(data) {
                    returnedData = data;
                    console.log(returnedData);
                    fillDeviations();
                    representProcessModel();
                });
            }

            function representProcessModel() {
                let svgXml = Viz(reprModel(returnedData["model"]), { format: "svg"});
                document.getElementById("svg_view").innerHTML = svgXml;
            }

            function applyChanges() {
                let af = document.getElementById("af_slider").value / 100.0;
                let pf = document.getElementById("pf_slider").value / 100.0;
                let zeta = document.getElementById("zeta_slider").value / 100.0;
                let noise_threshold = document.getElementById("lsk_slider").value / 100.0;
                let business_hours = document.getElementById("bh_enabled").checked;
                let dictio = {};
            }

            function hideEverything() {
                document.getElementById("lsk_activities0").style.display = "none";
                document.getElementById("lsk_cases0").style.display = "none";
                document.getElementById("tp_activities0").style.display = "none";
                document.getElementById("tp_cases0").style.display = "none";
            }

            function viewLskActivities() {
                hideEverything();
                document.getElementById("lsk_activities0").style.display = "";
            }

            function viewLskCases() {
                hideEverything();
                document.getElementById("lsk_cases0").style.display = "";
            }

            function viewTpActivities() {
                hideEverything();
                document.getElementById("tp_activities0").style.display = "";
            }

            function viewTpCases() {
                hideEverything();
                document.getElementById("tp_cases0").style.display = "";
            }

            function fillDeviations() {
                fillDivWithDeviations(returnedData["activity_lsk_conf"], "lsk_activities", returnedData["case_ids"]);
                fillDivWithDeviations(returnedData["lsk_conf_cases"], "lsk_cases", returnedData["case_ids"]);
                fillDivWithDeviations(returnedData["activity_ts_conf"], "tp_activities", returnedData["case_ids"]);
                fillDivWithDeviations(returnedData["ts_conf_cases"], "tp_cases", returnedData["case_ids"]);
            }

            function fillDivWithDeviations(deviations, target_div, case_ids) {
                let count = 0;
                for (let dev in deviations) {
                    let key = null;
                    let value = null;
                    if (Number.isInteger(dev)) {
                        key = case_ids[count];
                        value = deviations[dev];
                    }
                    else {
                        key = dev;
                        value = deviations[dev];
                    }
                    if (value.length > 0) {
                        let span1 = document.createElement("div");
                        let span2 = document.createElement("ul");
                        span1.setAttribute("id", target_div+"_S1_"+count);
                        span2.setAttribute("id", target_div+"_S2_"+count);
                        span2.style.display = "none";
                        document.getElementById(target_div).appendChild(span1);
                        document.getElementById(target_div).appendChild(span2);
                        span1.innerHTML = "<a href=\"javascript:changeVisibility('"+target_div+"_S2_"+count+"')\">"+key+" (n.dev: "+value.length+")</a>";
                        for (let subdev_idx in value) {
                            let subdev = value[subdev_idx];
                            let list_item = document.createElement("li");
                            list_item.innerHTML = subdev;
                            span2.appendChild(list_item);
                        }
                    }
                    count++;
                }
            }

            function changeVisibility(element_id) {
                if (document.getElementById(element_id).style.display == "none") {
                    document.getElementById(element_id).style.display = "";
                }
                else {
                    document.getElementById(element_id).style.display = "none";
                }
            }

            getProcess();
            console.log(getHostname());
        </script>
    </body>
</html>
